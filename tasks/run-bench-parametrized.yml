---
- name: initialize parameter dictionary
  set_fact:
    params: {}

- name: populate parameter dictionary
  set_fact:
    params: '{{ params | combine({item.0: item.1})}}'
  with_together:
  - '{{ parameter_names }}'
  - '{{ parameter_values }}'

- name: merge default variables to the benchmark-specific options
  set_fact:
    bench: '{{ (defaults | default({})) | combine(benchmark) }}'

- name: initialize string for path
  set_fact:
    output_folder: '{{ local_results_path }}/benchmark/{{ bench.name }}/machine/{{ inventory_hostname }}'
    run_id: '{{ bench.name }}-{{ inventory_hostname }}'

- name: add key/value pairs for each parameter (if any)
  set_fact:
    output_folder: '{{ output_folder }}/{{ item.key }}/{{ item.value }}'
    run_id: '{{ run_id }}-{{ item.key }}-{{ item.value }}'
  with_dict: '{{ params | default({}) }}'
  when: '"hey_ho_lets_go" not in parameter_names'

- name: ensure output folder exists
  local_action:
    module: file
    path: '{{ output_folder }}'
    state: directory

- name: run containerized benchmark
  include: run-container.yml
  when: 'bench.image is defined'

- name: run compose benchmark
  include: run-compose.yml
  when: 'bench.compose is defined'

- name: run script benchmark
  include: run-script.yml
  when: 'bench.script is defined'

- name: download results
  include: download-output.yml
  when: 'bench.fetch is defined'
