#!/usr/bin/env bash

print_usage() {
  echo "Usage: baseliner [-i inventory] [-o dir] [-f <conf>] [-m mode]"
  echo ""
  echo "Flags:"
  echo "  -i <inventory> inventory file passed to ansible (default: ./hosts)."
  echo "  -f <conf>      baseliner configuration file (default: ./config.yml)."
  echo "  -o <out-dir>   output directory (default: ./results)."
  echo "  -m <mode>      one of 'single-node' or 'parallel' (default: single-node)."
  exit $1
}

config_file="./config.yml"
inventory="./hosts"
results_dir="./results"
any_error_fatal="false"
stop_all="true"
mode="single-node"

while getopts ":f:a:o:i:m:sh" o; do
  case "${o}" in
    f)
      config_file="${OPTARG}"
      ;;
    i)
      inventory="${OPTARG}"
      ;;
    o)
      results_dir="${OPTARG}"
      ;;
    m)
      mode="${OPTARG}"
      ;;
    e)
      any_error_fatal="true"
      ;;
    s)
      stop_all="false"
      ;;
    h)
      print_usage 0
      ;;
    *)
      print_usage 1
      ;;
  esac
done

cat >ansible.cfg <<EOL
[defaults]
timeout = 120
retry_files_enabled = False
host_key_checking = False
callback_whitelist = profile_tasks, timer
EOL

if [ -n "${ANSIBLE_ROLES_PATH}" ]; then
  echo "roles_path = ${ANSIBLE_ROLES_PATH}" >> ansible.cfg
fi

export ANSIBLE_LOG_PATH="${results_dir}/baseliner.log"

cat >playbook.yml <<EOL
- hosts: all
  roles:
  - baseliner
EOL

mkdir -p "${results_dir}"

echo '' > "$ANSIBLE_LOG_PATH"

ansible-playbook \
  -i "${inventory}" \
  -e @"${config_file}" \
  -e local_results_path="${results_dir}" \
  -e remote_results_path="/tmp/results" \
  -e baseliner_execution_mode=$mode \
  -e stop_all="${stop_all}" \
  ./playbook.yml

rm -f ansible.cfg playbook.yml
